<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of read_bob_file</title>
  <meta name="keywords" content="read_bob_file">
  <meta name="description" content="READ_BOB_FILE Load RSAM-like data from a BOB file into a SAM object.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">GISMO</a> &gt; <a href="#">core</a> &gt; <a href="index.html">@rsam</a> &gt; read_bob_file.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for GISMO/core/@rsam&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>read_bob_file
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>READ_BOB_FILE Load RSAM-like data from a BOB file into a SAM object.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function self=read_bob_file(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">READ_BOB_FILE Load RSAM-like data from a BOB file into a SAM object.
 SAM is a generic term used here to represent any continuous data
 sampled at a regular time interval (usually 1 minute). This is a 
 format widely used within the USGS Volcano Hazards Programme which
 originally stems from the RSAM system (Endo &amp; Murray, 1989)

 Written for loading and plotting RSAM data at the Montserrat Volcano 
 Observatory (MVO), and then similar measurements derived from the VME 
 &quot;ltamon&quot; program and ampengfft and rbuffer2bsam which took Seisan 
 waveform files as input. 

 RSAM data are historically stored in &quot;BOB&quot; format, which consists
 of a 4 byte floating number for each minute of the year, for a 
 single station-channel.

 s = read_bob_file('file', file, 'snum', snum, 'enum', enum, 'sta', sta, 'chan', chan, 'measure', measure, 'seismogram_type', seismogram_type, 'units', units)

     file        % the path to the file. Substitutions enabled
                 'SSSS' replaced with sta
                 'CCC' replaced with chan
                 'MMMM' replaced with measure
                 'YYYY' replaced with year (from snum:enum)
                 These allow looping over many year files
     snum        % the start datenum
     enum        % the end   datenum
     sta         % station
     chan        % channel
     measure     % statistical measure, default is 'mean'
     seismogram_type % e.g. 'velocity' or 'displacement', default is 'raw'
     units       % units to label y-axis, e.g. 'nm/s' or 'nm' or 'cm2', default is 'counts'

 See also: sam, <a href="oneMinuteData.html" class="code" title="">oneMinuteData</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../GISMO/core/@correlation/find.html" class="code" title="function index = find(c,varargin)">find</a>	INDEX = FIND(c,'CLUST',WHICH_CLUSTER)</li><li><a href="findfiles.html" class="code" title="function self = findfiles(self, file)">findfiles</a>	Generate a list of files corresponding to the file pattern,</li><li><a href="rsam.html" class="code" title="">rsam</a>	</li><li><a href="../../../GISMO/core/@threecomp/isempty.html" class="code" title="function TF = isempty(TC)">isempty</a>	ISEMPTY Display threecomp object</li><li><a href="../../../GISMO/core/@waveform/isempty.html" class="code" title="function TF = isempty(w)">isempty</a>	ISEMPTY returns TRUE if waveform contains no data</li><li><a href="../../../GISMO/core/@waveform/max.html" class="code" title="function [Y, I] = max(w)">max</a>	MIN    Largest value of a waveform.</li><li><a href="../../../GISMO/core/@waveform/min.html" class="code" title="function [Y, I] = min(w)">min</a>	MIN    Smallest value of a waveform.</li><li><a href="../../../GISMO/core/dev/@NewCorrelation/find.html" class="code" title="function index = find(c, type, value)">find</a>	INDEX = FIND(c,'CLUST',WHICH_CLUSTER)</li><li><a href="../../../GISMO/libgismo/catmatrices.html" class="code" title="function cmatrix=catmatrices(matrix2,matrix1);">catmatrices</a>	CATMATRICES - concatenate 2D matrices of arbitrary size</li><li><a href="../../../GISMO/libgismo/ceilminute.html" class="code" title="function dnum=ceilminute(dnum, nummins)">ceilminute</a>	CEILMINUTE round up datenum to next minute mark</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="rsam.html" class="code" title="">rsam</a>	</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function self = findfiles(self, file)</a></li><li><a href="#_sub2" class="code">function self = load(self, f)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function self=read_bob_file(varargin)</a>
0002 <span class="comment">%READ_BOB_FILE Load RSAM-like data from a BOB file into a SAM object.</span>
0003 <span class="comment">% SAM is a generic term used here to represent any continuous data</span>
0004 <span class="comment">% sampled at a regular time interval (usually 1 minute). This is a</span>
0005 <span class="comment">% format widely used within the USGS Volcano Hazards Programme which</span>
0006 <span class="comment">% originally stems from the RSAM system (Endo &amp; Murray, 1989)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Written for loading and plotting RSAM data at the Montserrat Volcano</span>
0009 <span class="comment">% Observatory (MVO), and then similar measurements derived from the VME</span>
0010 <span class="comment">% &quot;ltamon&quot; program and ampengfft and rbuffer2bsam which took Seisan</span>
0011 <span class="comment">% waveform files as input.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% RSAM data are historically stored in &quot;BOB&quot; format, which consists</span>
0014 <span class="comment">% of a 4 byte floating number for each minute of the year, for a</span>
0015 <span class="comment">% single station-channel.</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% s = read_bob_file('file', file, 'snum', snum, 'enum', enum, 'sta', sta, 'chan', chan, 'measure', measure, 'seismogram_type', seismogram_type, 'units', units)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%     file        % the path to the file. Substitutions enabled</span>
0020 <span class="comment">%                 'SSSS' replaced with sta</span>
0021 <span class="comment">%                 'CCC' replaced with chan</span>
0022 <span class="comment">%                 'MMMM' replaced with measure</span>
0023 <span class="comment">%                 'YYYY' replaced with year (from snum:enum)</span>
0024 <span class="comment">%                 These allow looping over many year files</span>
0025 <span class="comment">%     snum        % the start datenum</span>
0026 <span class="comment">%     enum        % the end   datenum</span>
0027 <span class="comment">%     sta         % station</span>
0028 <span class="comment">%     chan        % channel</span>
0029 <span class="comment">%     measure     % statistical measure, default is 'mean'</span>
0030 <span class="comment">%     seismogram_type % e.g. 'velocity' or 'displacement', default is 'raw'</span>
0031 <span class="comment">%     units       % units to label y-axis, e.g. 'nm/s' or 'nm' or 'cm2', default is 'counts'</span>
0032 <span class="comment">%</span>
0033 <span class="comment">% See also: sam, oneMinuteData</span>
0034 
0035     self = <a href="rsam.html" class="code" title="">rsam</a>(); <span class="comment">% Create a blank sam object</span>
0036     
0037     classFields = {<span class="string">'sta'</span>,<span class="string">'chan'</span>,<span class="string">'measure'</span>,<span class="string">'seismogram_type'</span>,<span class="string">'units'</span>,<span class="string">'snum'</span>,<span class="string">'enum'</span>, <span class="string">'dnum'</span>, <span class="string">'data'</span>};
0038     p = inputParser;
0039     p.addParameter(<span class="string">'file'</span>, <span class="string">''</span>);
0040     <span class="keyword">for</span> n=1:numel(classFields)
0041        p.addParameter(classFields{n}, self.(classFields{n}));
0042     <span class="keyword">end</span>
0043     p.parse(varargin{:});
0044     
0045     <span class="comment">% modify class values based on user-provided values</span>
0046     <span class="keyword">for</span> n = 1:numel(classFields)
0047        self.(classFields{n}) = p.Results.(classFields{n});
0048     <span class="keyword">end</span>
0049     file = p.Results.file;
0050         
0051         
0052 
0053     <span class="comment">%%%% CREATING SAM OBJECT FROM A BOB FILE</span>
0054     <span class="comment">% check if filename has a year in it, if it does</span>
0055     <span class="comment">% make sure snum doesn't start before this year</span>
0056     <span class="comment">% and enum doesn't end after this year</span>
0057     <span class="keyword">if</span> ~<a href="../../../GISMO/core/@threecomp/isempty.html" class="code" title="function TF = isempty(TC)">isempty</a>(file)
0058         dummy = regexp(file, <span class="string">'(\d+)'</span>, <span class="string">'match'</span>);
0059         <span class="keyword">if</span> ~<a href="../../../GISMO/core/@threecomp/isempty.html" class="code" title="function TF = isempty(TC)">isempty</a>(dummy)
0060             yyyy = str2num(dummy{end});
0061             d=datevec(now);yearnow=d(1);clear d
0062             <span class="keyword">if</span> yyyy&gt;=1980 &amp; yyyy&lt;=yearnow
0063                 self.snum = <a href="../../../GISMO/core/@waveform/max.html" class="code" title="function [Y, I] = max(w)">max</a>([self.snum datenum(yyyy,1,1)]);
0064                 self.enum = <a href="../../../GISMO/core/@waveform/min.html" class="code" title="function [Y, I] = min(w)">min</a>([self.enum datenum(yyyy,12,31,23,59,59)]);
0065             <span class="keyword">end</span>
0066         <span class="keyword">end</span>
0067 
0068         <span class="comment">% Generate a list of files</span>
0069         self = <a href="findfiles.html" class="code" title="function self = findfiles(self, file)">findfiles</a>(self, file);
0070 
0071         <span class="comment">% Load the data</span>
0072         <span class="keyword">for</span> f = self.files
0073             <span class="keyword">if</span> f.found
0074                 self = self.load();
0075             <span class="keyword">end</span>
0076         <span class="keyword">end</span>
0077     <span class="keyword">end</span>
0078 <span class="keyword">end</span>
0079 
0080 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0081 <a name="_sub1" href="#_subfunctions" class="code">function self = findfiles(self, file)</a>
0082     <span class="comment">% Generate a list of files corresponding to the file pattern,</span>
0083     <span class="comment">% snum and enum given.</span>
0084 
0085     filenum = 0;
0086 
0087     <span class="comment">% substitute for station</span>
0088     file = regexprep(file, <span class="string">'SSSS'</span>, self.sta);
0089 
0090     <span class="comment">% substitute for channel</span>
0091     file = regexprep(file, <span class="string">'CCC'</span>, self.chan);
0092 
0093     <span class="comment">% substitute for measure</span>
0094     file = regexprep(file, <span class="string">'MMMM'</span>, self.measure);             
0095 
0096     <span class="comment">% set start year and month, and end year and month</span>
0097     [syyy sm]=datevec(self.snum);
0098     [eyyy em]=datevec(self.enum);
0099 
0100     <span class="keyword">for</span> yyyy=syyy:eyyy
0101 
0102         filenum = filenum + 1;
0103         files(filenum) = struct(<span class="string">'file'</span>, file, <span class="string">'snum'</span>, self.snum, <span class="string">'enum'</span>, self.enum, <span class="string">'found'</span>, false);
0104 
0105         <span class="comment">% Check year against start year</span>
0106         <span class="keyword">if</span> yyyy~=syyy
0107             <span class="comment">% if not the first year, start on 1st Jan</span>
0108             files(filenum).snum = datenum(yyyy,1,1);
0109         <span class="keyword">end</span>
0110 
0111         <span class="comment">% Check year against end year</span>
0112         <span class="keyword">if</span> yyyy~=eyyy
0113             <span class="comment">% if not the last year, end at 31st Dec</span>
0114             files(filenum).enum = datenum(yyyy,12,31,23,59,59);
0115         <span class="keyword">end</span>   
0116 
0117         <span class="comment">% Substitute for year</span>
0118         files(filenum).file = regexprep(files(filenum).file, <span class="string">'YYYY'</span>, sprintf(<span class="string">'%04d'</span>,yyyy) );
0119         fprintf(<span class="string">'Looking for file: %s'</span>,files(filenum).file);
0120 
0121         <span class="keyword">if</span> exist(files(filenum).file, <span class="string">'file'</span>)
0122             files(filenum).found = true;
0123             fprintf(<span class="string">' - found\n'</span>);
0124         <span class="keyword">else</span>
0125             fprintf(<span class="string">' - not found\n'</span>);
0126         <span class="keyword">end</span>
0127     <span class="keyword">end</span>
0128     self.files = files;
0129 <span class="keyword">end</span>
0130 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0131 <a name="_sub2" href="#_subfunctions" class="code">function self = load(self, f)</a>
0132 <span class="comment">% Purpose:</span>
0133 <span class="comment">%    Loads derived data from a binary file in the BOB RSAM format</span>
0134 <span class="comment">%    The pointer position at which to reading from the binary file is determined from f.snum</span>
0135 <span class="comment">%    Load all the data from f.snum to f.enum. So if timewindow is 12:34:56 to 12:44:56,</span>
0136 <span class="comment">%    it is the samples at 12:35, ..., 12:44 - i.e. 10 of them.</span>
0137 <span class="comment">%</span>
0138 <span class="comment">% Input:</span>
0139 <span class="comment">%    f - a structure which contains 'file', 'snum', 'enum' and 'found' parameters</span>
0140 <span class="comment">% Author:</span>
0141 <span class="comment">%   Glenn Thompson, MVO, 2000</span>
0142 
0143     <span class="comment">% initialise return variables</span>
0144     datafound=false;
0145     dnum=[];
0146     data=[];
0147 
0148     [yyyy mm]=datevec(f.snum);
0149     days=365;
0150     <span class="keyword">if</span> mod(yyyy,4)==0
0151         days=366;
0152     <span class="keyword">end</span>
0153 
0154     datapointsperday = 1440;
0155     headersamples = 0;
0156     tz=0;
0157     <span class="keyword">if</span> strfind(f.file,<span class="string">'RSAM'</span>)
0158         headersamples=datapointsperday;
0159         tz=-4;
0160     <span class="keyword">end</span>
0161     startsample = ceil( (f.snum-datenum(yyyy,1,1))*datapointsperday)+headersamples;
0162     endsample   = (f.enum-datenum(yyyy,1,1)) *datapointsperday + headersamples;
0163     <span class="comment">%endsample   = floor( max([ datenum(yyyy,12,31,23,59,59) f.enum-datenum(yyyy,1,1) ]) *datapointsperday);</span>
0164     nsamples    = endsample - startsample + 1;
0165 
0166     <span class="comment">% create dnum &amp; blank data vector</span>
0167     dnum = <a href="../../../GISMO/libgismo/ceilminute.html" class="code" title="function dnum=ceilminute(dnum, nummins)">ceilminute</a>(f.snum)+(0:nsamples-1)/datapointsperday - tz/24;
0168     data(1:length(dnum))=NaN;
0169 
0170     <span class="keyword">if</span> f.found    
0171         <span class="comment">% file found</span>
0172         debug.print_debug(sprintf( <span class="string">'Loading data from %s, position %d to %d of %d'</span>, <span class="keyword">...</span>
0173              f.file, startsample,(startsample+nsamples-1),(datapointsperday*days) ),3); 
0174 
0175         fid=fopen(f.file,<span class="string">'r'</span>, <span class="string">'l'</span>); <span class="comment">% big-endian for Sun, little-endian for PC</span>
0176 
0177         <span class="comment">% Position the pointer</span>
0178         offset=(startsample)*4;
0179         fseek(fid,offset,<span class="string">'bof'</span>);
0180 
0181         <span class="comment">% Read the data</span>
0182         [data,numlines] = fread(fid, nsamples, <span class="string">'float32'</span>);
0183         fclose(fid);
0184         debug.print_debug(sprintf(<span class="string">'mean of data loaded is %e'</span>,nanmean(data)),1);
0185 
0186         <span class="comment">% Transpose to give same dimensions as dnum</span>
0187         data=data';
0188 
0189         <span class="comment">% Test for Nulls</span>
0190         <span class="keyword">if</span> length(<a href="../../../GISMO/core/@correlation/find.html" class="code" title="function index = find(c,varargin)">find</a>(data&gt;0)) &gt; 0
0191             datafound=true;
0192         <span class="keyword">end</span>    
0193     <span class="keyword">end</span>
0194 
0195     <span class="comment">% Now paste together the matrices</span>
0196     self.dnum = <a href="../../../GISMO/libgismo/catmatrices.html" class="code" title="function cmatrix=catmatrices(matrix2,matrix1);">catmatrices</a>(dnum, self.dnum);
0197     self.data = <a href="../../../GISMO/libgismo/catmatrices.html" class="code" title="function cmatrix=catmatrices(matrix2,matrix1);">catmatrices</a>(data, self.data);
0198 
0199     <span class="keyword">if</span> ~datafound
0200         debug.print_debug(sprintf(<span class="string">'%s: No data loaded from file %s'</span>,mfilename,f.file),1);
0201     <span class="keyword">end</span>
0202 
0203     <span class="comment">% eliminate any data outside range asked for - MAKE THIS A</span>
0204     <span class="comment">% SEPARATE FN IF AT ALL</span>
0205     i = <a href="../../../GISMO/core/@correlation/find.html" class="code" title="function index = find(c,varargin)">find</a>(self.dnum &gt;= self.snum &amp; self.dnum &lt;= self.enum);
0206     self.dnum = self.dnum(i);
0207     self.data = self.data(i);
0208 
0209     <span class="comment">% Fill NULL values with NaN</span>
0210     i = <a href="../../../GISMO/core/@correlation/find.html" class="code" title="function index = find(c,varargin)">find</a>(self.data == -998);
0211     self.data(i) = NaN;
0212     i = <a href="../../../GISMO/core/@correlation/find.html" class="code" title="function index = find(c,varargin)">find</a>(self.data == 0);
0213     self.data(i) = NaN;
0214 
0215 <span class="keyword">end</span>
0216</pre></div>
<hr><address>Generated on Wed 12-Oct-2016 17:36:30 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>