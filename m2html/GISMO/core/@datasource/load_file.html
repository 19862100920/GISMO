<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of load_file</title>
  <meta name="keywords" content="load_file">
  <meta name="description" content="grab all the variables in a matlab file, and flip through them, returning">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">GISMO</a> &gt; <a href="#">core</a> &gt; <a href="index.html">@datasource</a> &gt; load_file.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for GISMO/core/@datasource&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>load_file
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>grab all the variables in a matlab file, and flip through them, returning</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function allObj = load_file(ds,searchClass,scnl,startt,endt) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">grab all the variables in a matlab file, and flip through them, returning
those that match the criteria
 allObj = load_file(datasource,searchClass,scnl,starttime,endtime)
   DATASOURCE is a single datasource object (of type &quot;file&quot;)
   SEARCHCLASS is a string containing the name of the class you are
   searching for.  eg, 'double','waveform', etc.
   SCNL is an array of scnlobjects which hold
   station/channel/network/location matches.
   STARTTIME is the starting time in matlab datenum format
   ENDTIME is the ending time in matlab datenum format

   This function returns a 1xN dimesional array of all relevent objects
   found within the searched file(s).  All variable identity from within
   the files is lost.
   - - -
   SO, for example, in the context of searching for waveform data...
   if there is a searchfile, that contians the variables: W (1x3
   waveform), W2 (1x1 waveform), MyWc (2x2 cell with waveforms in it), and
   D (double).

   the load_file method will rip out each and every waveform (recursing
   through cells), then lump all of them into a large 1xN waveform.  Each
   waveform that doesn't meet the SCNL criteria is discarded.  Then, all
   waveforms that don't have data somewhere within the starttime-endtime
   timeframe will be discarded as well.

   It is important to note that the recovered objects aren't trimmed to
   the starttime-endtime timeeframe.  That is, individual objects are not
   altered through the use of this function.


 Any object can be loaded from file, however since this was designed to
 work with seismic data, it must have an ISMEMBER function that takes as
 it's parameters the object itself and a SCNLobject.  Also required is the
 [Starts Ends] = GETTIMERANGE(obj) function. (see waveform/gettimerange
 for an example implementation.

 see also ISMEMBER, WAVEFORM/GETTIMERANGE</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="getfilename.html" class="code" title="function [filename] = getfilename(ds, scnls, starttimes)">getfilename</a>	GETFILENAME returns a filename that is associated with a single SCNL</li><li><a href="../../../GISMO/core/@rsam/load.html" class="code" title="function self = load(self)">load</a>	Purpose:</li><li><a href="../../../GISMO/core/@scnlobject/ismember.html" class="code" title="function [results, loc] = ismember(A,B)">ismember</a>	ISMEMBER for scnlobjects</li><li><a href="../../../GISMO/core/@waveform/gettimerange.html" class="code" title="function [startTimeList endTimeList] = gettimerange(w)">gettimerange</a>	GETTIMERANGE returns the list of start and end times from a waveform array</li><li><a href="../../../GISMO/core/@waveform/ismember.html" class="code" title="function [results, loc] = ismember(mywave,anythingelse)">ismember</a>	ISMEMBER waveform implementation of ismember</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function hasValidRange = isWithinTimeRange(myObj,startt,endt)</a></li><li><a href="#_sub2" class="code">function mObj = getFromCells(searchClass, mycell)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function allObj = load_file(ds,searchClass,scnl,startt,endt)</a>
0002    <span class="comment">%grab all the variables in a matlab file, and flip through them, returning</span>
0003    <span class="comment">%those that match the criteria</span>
0004    <span class="comment">% allObj = load_file(datasource,searchClass,scnl,starttime,endtime)</span>
0005    <span class="comment">%   DATASOURCE is a single datasource object (of type &quot;file&quot;)</span>
0006    <span class="comment">%   SEARCHCLASS is a string containing the name of the class you are</span>
0007    <span class="comment">%   searching for.  eg, 'double','waveform', etc.</span>
0008    <span class="comment">%   SCNL is an array of scnlobjects which hold</span>
0009    <span class="comment">%   station/channel/network/location matches.</span>
0010    <span class="comment">%   STARTTIME is the starting time in matlab datenum format</span>
0011    <span class="comment">%   ENDTIME is the ending time in matlab datenum format</span>
0012    <span class="comment">%</span>
0013    <span class="comment">%   This function returns a 1xN dimesional array of all relevent objects</span>
0014    <span class="comment">%   found within the searched file(s).  All variable identity from within</span>
0015    <span class="comment">%   the files is lost.</span>
0016    <span class="comment">%   - - -</span>
0017    <span class="comment">%   SO, for example, in the context of searching for waveform data...</span>
0018    <span class="comment">%   if there is a searchfile, that contians the variables: W (1x3</span>
0019    <span class="comment">%   waveform), W2 (1x1 waveform), MyWc (2x2 cell with waveforms in it), and</span>
0020    <span class="comment">%   D (double).</span>
0021    <span class="comment">%</span>
0022    <span class="comment">%   the load_file method will rip out each and every waveform (recursing</span>
0023    <span class="comment">%   through cells), then lump all of them into a large 1xN waveform.  Each</span>
0024    <span class="comment">%   waveform that doesn't meet the SCNL criteria is discarded.  Then, all</span>
0025    <span class="comment">%   waveforms that don't have data somewhere within the starttime-endtime</span>
0026    <span class="comment">%   timeframe will be discarded as well.</span>
0027    <span class="comment">%</span>
0028    <span class="comment">%   It is important to note that the recovered objects aren't trimmed to</span>
0029    <span class="comment">%   the starttime-endtime timeeframe.  That is, individual objects are not</span>
0030    <span class="comment">%   altered through the use of this function.</span>
0031    <span class="comment">%</span>
0032    <span class="comment">%</span>
0033    <span class="comment">% Any object can be loaded from file, however since this was designed to</span>
0034    <span class="comment">% work with seismic data, it must have an ISMEMBER function that takes as</span>
0035    <span class="comment">% it's parameters the object itself and a SCNLobject.  Also required is the</span>
0036    <span class="comment">% [Starts Ends] = GETTIMERANGE(obj) function. (see waveform/gettimerange</span>
0037    <span class="comment">% for an example implementation.</span>
0038    <span class="comment">%</span>
0039    <span class="comment">% see also ISMEMBER, WAVEFORM/GETTIMERANGE</span>
0040    error(<span class="string">'Should never call this function'</span>);
0041    <span class="comment">%The file looks a little opaque because it deals generically with classes</span>
0042    <span class="comment">%and objects, rather than tying itself down to any particular object.</span>
0043    allfilen = <a href="getfilename.html" class="code" title="function [filename] = getfilename(ds, scnls, starttimes)">getfilename</a>(ds,scnl,startt);
0044    <span class="keyword">for</span> thisfile = 1 : numel(allfilen)
0045       filen = allfilen{thisfile};
0046       stuff=  <a href="../../../GISMO/core/@rsam/load.html" class="code" title="function self = load(self)">load</a>(filen);
0047       fieldn = fieldnames(stuff);
0048       
0049       <span class="comment">%Look through all variables that were loaded, looking for the desired</span>
0050       <span class="comment">%class.  If a cell is encountered, then look for occurrences of that class</span>
0051       <span class="comment">%within the cell (recursively).</span>
0052       
0053       myObjectMask = false(size(fieldn));
0054       holder = cell(size(fieldn));
0055       <span class="keyword">for</span> fieldidx = 1:numel(fieldn)
0056          thisfield =  fieldn{fieldidx};
0057          <span class="comment">%grab all myObjects</span>
0058          <span class="keyword">if</span> isa(stuff.(thisfield),searchClass)
0059             holder(fieldidx) = {reshape(stuff.(thisfield),1,numel(stuff.(thisfield)))};
0060             myObjectMask(fieldidx) = true;
0061             stuff.(thisfield) = {};
0062          <span class="keyword">elseif</span> isa(stuff.(thisfield),<span class="string">'cell'</span>)
0063             holder(fieldidx) = {<a href="#_sub2" class="code" title="subfunction mObj = getFromCells(searchClass, mycell)">getFromCells</a>(searchClass,stuff.(thisfield))};
0064             myObjectMask(fieldidx) = true;
0065          <span class="keyword">else</span>
0066             stuff.(thisfield) = {};
0067          <span class="keyword">end</span>
0068       <span class="keyword">end</span>
0069       myObj = [holder{myObjectMask}];
0070       myObj = myObj(<a href="../../../GISMO/core/@scnlobject/ismember.html" class="code" title="function [results, loc] = ismember(A,B)">ismember</a>(myObj,scnl));
0071       
0072       
0073       <span class="comment">%now get rid of any that don't match the time criteria.</span>
0074       hasValidRange = <a href="#_sub1" class="code" title="subfunction hasValidRange = isWithinTimeRange(myObj,startt,endt)">isWithinTimeRange</a>(myObj,startt,endt);
0075       allObj(thisfile) = {myObj(hasValidRange)};
0076       
0077       
0078    <span class="keyword">end</span>
0079    allObj = [allObj{:}];
0080 <span class="keyword">end</span>
0081 
0082 <a name="_sub1" href="#_subfunctions" class="code">function hasValidRange = isWithinTimeRange(myObj,startt,endt)</a>
0083    
0084    [theseStarts theseEnds] = <a href="../../../GISMO/core/@waveform/gettimerange.html" class="code" title="function [startTimeList endTimeList] = gettimerange(w)">gettimerange</a>(myObj);
0085    hasValidRange = false(size(theseStarts));
0086    
0087    <span class="comment">%   if isempty(theseStarts) || isempty(theseEnds)</span>
0088    <span class="comment">%     warning('Datasource:ObjectNoTimes',...</span>
0089    <span class="comment">%       'One or more objects have no start or end times associated with them');</span>
0090    <span class="comment">%     return;</span>
0091    <span class="comment">%   end</span>
0092    
0093    <span class="comment">%check each object's range against all requested ranges</span>
0094    <span class="keyword">for</span> timeidx = 1:numel(startt)
0095       requestedStart = startt(timeidx);
0096       requestedEnd = endt(timeidx);
0097       
0098       <span class="comment">% make sure the data doesn't start AFTER requested data...</span>
0099       validStarts = (theseStarts &lt;=requestedEnd);
0100       <span class="comment">% ...and make sure the data deosn't end BEFORE requested data</span>
0101       validEnds = (theseEnds &gt;= requestedStart);
0102       
0103       <span class="comment">%add objects that match the criteria to the OK list</span>
0104       hasValidRange = hasValidRange | (validStarts &amp; validEnds);
0105    <span class="keyword">end</span>
0106 <span class="keyword">end</span>
0107 
0108 
0109 <a name="_sub2" href="#_subfunctions" class="code">function mObj = getFromCells(searchClass, mycell)</a>
0110    <span class="comment">% returns an 1xN array of objects</span>
0111    
0112    <span class="comment">%might break if searchClass == 'cell'. but I haven't tested it</span>
0113    searchFn = @(x) isa (x, searchClass);
0114    makeRows = @(x) reshape(x,1,numel(x));
0115    
0116    target = cellfun(searchFn, mycell);
0117    objs = cellfun(makeRows, mycell(target), <span class="string">'uniformoutput'</span>, false);
0118    
0119    holdsCell = cellfun(@iscell, mycell);
0120    <span class="keyword">if</span> any(holdsCell)
0121       mObj = <a href="#_sub2" class="code" title="subfunction mObj = getFromCells(searchClass, mycell)">getFromCells</a>(searchClass, mycell{holdsCell}); <span class="comment">%recurse</span>
0122    <span class="keyword">else</span>
0123       mObj = {};
0124    <span class="keyword">end</span>
0125    
0126    mObj = [mObj{:} objs{:}];
0127 <span class="keyword">end</span>
0128    
0129    <span class="comment">%{</span>
0130    holdsTarget = false(size(mycell));
0131    <span class="keyword">for</span> i=1:numel(mycell);
0132       holdsTarget(i) = isa(mycell{i}, searchClass);
0133       <span class="keyword">if</span> isa(mycell{i},searchClass),
0134          holdsTarget(i) = true;
0135          mycell(i) = {reshape(mycell{i},1,numel(mycell{i}))}; <span class="comment">%make all myObjects 1xN</span>
0136       <span class="keyword">elseif</span> isa(mycell{i},<span class="string">'cell'</span>) <span class="comment">%it's a cell, let's recurse</span>
0137          mycell(i) = {myObjectsFromCells(mycell{i})};  <span class="comment">%pull myObjects from the cell and bring them to this level.</span>
0138       <span class="keyword">end</span>
0139    <span class="keyword">end</span>
0140    mObj= [mycell{holdsTarget}];
0141 <span class="keyword">end</span>
0142 <span class="comment">%}</span></pre></div>
<hr><address>Generated on Wed 12-Oct-2016 17:36:30 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>