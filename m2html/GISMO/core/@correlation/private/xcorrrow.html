<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of xcorrrow</title>
  <meta name="keywords" content="xcorrrow">
  <meta name="description" content="XCORRROW Cross correlation for one or more traces.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">GISMO</a> &gt; <a href="#">core</a> &gt; <a href="../index.html">@correlation</a> &gt; <a href="index.html">private</a> &gt; xcorrrow.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for GISMO/core/@correlation/private&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>xcorrrow
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>XCORRROW Cross correlation for one or more traces.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function d = xcorrrow(d,c,index) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">XCORRROW Cross correlation for one or more traces.
 D = XCORR1XR(D,C,STYLE) This private function performs cross correlations
 for a subset of traces. It differs from the XCORR1XR algorithm in that it
 fills both halves of the correlation matrix. While this is unnecessary
 when correlating all waveforms, it is necessary when doing just a subset
 of traces. This should be of little concern to most users. All steps are
 included in this function. That is, no calls to the Matlab built-in xcorr
 are used. This code is a little kludgy since it mixes both the original d
 structure (predates the internal use of waveform objects) with the later
 wave-based correlation objects. This is the reason it reads in both D and
 C arguments. STYLE denotes whether or not polynomial interpolation should
 be used to refine cross correlations to subsample precision.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="../../../../GISMO/core/@correlation/get.html" class="code" title="function val = get(c,prop_name)">get</a>	GET - Get correlation properties</li><li><a href="../../../../GISMO/core/@datasource/get.html" class="code" title="function val = get(ds, propertyname)">get</a>	</li><li><a href="../../../../GISMO/core/@drumplot/get.html" class="code" title="function val = get(h,prop_name)">get</a>	GET: Get drumplot properties</li><li><a href="../../../../GISMO/core/@filterobject/get.html" class="code" title="function val = get(f, prop_name)">get</a>	GET - Get filterobject properties</li><li><a href="../../../../GISMO/core/@scnlobject/get.html" class="code" title="function stuff = get(scnl, prop_name)">get</a>	GET for the scnl object</li><li><a href="../../../../GISMO/core/@spectralobject/fft.html" class="code" title="function [varargout] = fft(s, w)">fft</a>	FFT Discrete Fourier transform.  OVERLOADED for waveform & Spectralobject</li><li><a href="../../../../GISMO/core/@spectralobject/get.html" class="code" title="function out = get(s, prop_name)">get</a>	GET - Get properties for spectralobject</li><li><a href="../../../../GISMO/core/@spectralobject/ifft.html" class="code" title="function [varargout] = ifft(s, w)">ifft</a>	IFFT Inverse discrete Fourier transform.  OVERLOADED FOR Spectralobject</li><li><a href="../../../../GISMO/core/@threecomp/get.html" class="code" title="function val = get(TC,varargin)">get</a>	GET    Get threecomp object properties.</li><li><a href="../../../../GISMO/core/@waveform/abs.html" class="code" title="function w = abs(w)">abs</a>	ABS Absolute value for the waveform object</li><li><a href="../../../../GISMO/core/@waveform/get.html" class="code" title="function val = get(w,prop_name)">get</a>	GET Get waveform properties</li><li><a href="../../../../GISMO/core/@waveform/max.html" class="code" title="function [Y, I] = max(w)">max</a>	MIN    Largest value of a waveform.</li><li><a href="../../../../GISMO/core/dev/@NewCorrelation/get.html" class="code" title="function val = get(c,prop_name)">get</a>	GET - Get correlation properties</li><li><a href="../../../../GISMO/deprecated/@helicorder/get.html" class="code" title="function val = get(h,prop_name)">get</a>	GET: Get helicorder properties</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="../../../../GISMO/core/@correlation/xcorr.html" class="code" title="function c=xcorr(c,varargin)">xcorr</a>	C = XCORR(C)</li><li><a href="../../../../GISMO/core/dev/@NewCorrelation/NewCorrelation.html" class="code" title="">NewCorrelation</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function d = xcorrrow(d,c,index)</a>
0002 
0003 <span class="comment">%XCORRROW Cross correlation for one or more traces.</span>
0004 <span class="comment">% D = XCORR1XR(D,C,STYLE) This private function performs cross correlations</span>
0005 <span class="comment">% for a subset of traces. It differs from the XCORR1XR algorithm in that it</span>
0006 <span class="comment">% fills both halves of the correlation matrix. While this is unnecessary</span>
0007 <span class="comment">% when correlating all waveforms, it is necessary when doing just a subset</span>
0008 <span class="comment">% of traces. This should be of little concern to most users. All steps are</span>
0009 <span class="comment">% included in this function. That is, no calls to the Matlab built-in xcorr</span>
0010 <span class="comment">% are used. This code is a little kludgy since it mixes both the original d</span>
0011 <span class="comment">% structure (predates the internal use of waveform objects) with the later</span>
0012 <span class="comment">% wave-based correlation objects. This is the reason it reads in both D and</span>
0013 <span class="comment">% C arguments. STYLE denotes whether or not polynomial interpolation should</span>
0014 <span class="comment">% be used to refine cross correlations to subsample precision.</span>
0015 
0016 <span class="comment">% Author: Michael West, Geophysical Institute, Univ. of Alaska Fairbanks</span>
0017 <span class="comment">% $Date$</span>
0018 <span class="comment">% $Revision$</span>
0019 
0020 
0021 <span class="comment">% PREP NECESSARY TERMS</span>
0022 [M,N] = size(d.w);
0023 pretrig = 86400*(d.trig-d.start);   <span class="comment">% time between trace start and trigger</span>
0024 l = (1./d.Fs)*[-M+1:M-1]';        <span class="comment">% lag vector</span>
0025 <span class="comment">% next two lines are equivalent ways to get normalization coefficients</span>
0026 wcoeff = 1./sqrt(sum(d.w.*d.w));
0027 <span class="comment">%for i = 1:size(d.w,2), wcoeff(i) = 1./norm(d.w(:,i)); end;</span>
0028 
0029 
0030 <span class="comment">% CREATE MATRICES IF NEEDED</span>
0031 nn = <a href="../../../../GISMO/core/@correlation/get.html" class="code" title="function val = get(c,prop_name)">get</a>(c,<span class="string">'traces'</span>);
0032 <span class="keyword">if</span> (size(c.C,1) == 0)
0033     c.C = nan(nn);
0034 <span class="keyword">end</span>
0035 <span class="keyword">if</span> (size(c.L,1) == 0)
0036     c.L = nan(nn);
0037 <span class="keyword">end</span>
0038 
0039 
0040 <span class="comment">% do not overwrite matrices if they are only being added to</span>
0041 <span class="keyword">if</span> size(c.C,1)==0
0042     d.C = eye(length(d.trig),<span class="string">'single'</span>);
0043     eraseC = 1;
0044 <span class="keyword">else</span>
0045     d.C = c.C;
0046     eraseC = 0;
0047 <span class="keyword">end</span>
0048 
0049 <span class="keyword">if</span> size(c.L,1)==0
0050     d.L = zeros(length(d.trig),<span class="string">'single'</span>);
0051     eraseL = 1;
0052 <span class="keyword">else</span>
0053     d.L = c.L;
0054     eraseL = 0;
0055 <span class="keyword">end</span>
0056 
0057 
0058 <span class="comment">% GET FFT OF TRACES</span>
0059 X = <a href="../../../../GISMO/core/@spectralobject/fft.html" class="code" title="function [varargout] = fft(s, w)">fft</a>(d.w,2^nextpow2(2*M-1));
0060 Xc = conj(X);
0061 [MX,NX] = size(X);
0062 
0063 
0064 <span class="comment">% LOOP THROUGH ROWS OF SIMILARITY MATRIX</span>
0065 <span class="keyword">for</span> n = index
0066     cols = 1:N;
0067     <span class="comment">% multiply fourier series and transform back to time domain</span>
0068     <span class="comment">%CC = (X(:,n) * ones(1,length(cols))) .* Xc(:,cols);</span>
0069     CC = repmat(X(:,n),1,length(cols)) .* Xc(:,cols);
0070     corr = <a href="../../../../GISMO/core/@spectralobject/ifft.html" class="code" title="function [varargout] = ifft(s, w)">ifft</a>(CC);
0071     corr = corr([end-M+2:<span class="keyword">end</span>,1:M],:);
0072         
0073     <span class="comment">% USE POLYNOMIAL INTERPOLATION</span>
0074     [maxtest,indx1] = <a href="../../../../GISMO/core/@waveform/max.html" class="code" title="function [Y, I] = max(w)">max</a>(corr(2:end-1,:));
0075     [mm,nn] = size(corr);
0076     indx2 = (indx1+1) + mm*[0:nn-1];     <span class="comment">% convert to matrix index</span>
0077     lag = repmat( l , 1 , size(corr,2) );  <span class="comment">% replace size statement with nn</span>
0078     lagM   = lag([ indx2-1 ; indx2 ; indx2+1 ]) + repmat(pretrig(cols)'-pretrig(n)',3,1);
0079     corrM  = corr([ indx2-1 ; indx2 ; indx2+1 ]);
0080     <span class="keyword">for</span> z = 1:numel(cols)
0081         p = polyfit( lagM(:,z) , corrM(:,z) , 2 );
0082         Ltmp = -0.5*p(2)/p(1);
0083         <span class="keyword">if</span> <a href="../../../../GISMO/core/@waveform/abs.html" class="code" title="function w = abs(w)">abs</a>(Ltmp)&lt;eps(<span class="string">'single'</span>)
0084             Ltmp = 0;
0085         <span class="keyword">end</span>
0086         d.L(n,cols(z))  = Ltmp;
0087         d.C(n,cols(z)) = polyval( p , d.L(n,cols(z)) ) .* wcoeff(n) .* wcoeff(cols(z));
0088     <span class="keyword">end</span>
0089 
0090 <span class="keyword">end</span>
0091 
0092 <span class="comment">% FILL IN OTHER HALF OF MATRIX</span>
0093 d.C(:,index) = d.C(index,:)';
0094 
0095 <span class="keyword">if</span> eraseL
0096     d.L = [];
0097 <span class="keyword">else</span>
0098     d.L(:,index) = -1* d.L(index,:)';
0099 <span class="keyword">end</span>
0100 
0101 
0102 <span class="keyword">if</span> eraseC
0103     d.C = [];
0104 <span class="keyword">else</span>
0105     d.C(:,index) = d.C(index,:)';
0106 <span class="keyword">end</span>
0107 
0108 
0109</pre></div>
<hr><address>Generated on Wed 12-Oct-2016 17:36:30 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>