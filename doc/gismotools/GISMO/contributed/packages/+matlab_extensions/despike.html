<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of despike</title>
  <meta name="keywords" content="despike">
  <meta name="description" content="======================================================================">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../../index.html">Home</a> &gt;  <a href="#">gismotools</a> &gt; <a href="../../../index.html">GISMO</a> &gt; <a href="#">contributed</a> &gt; <a href="#">packages</a> &gt; <a href="index.html">+matlab_extensions</a> &gt; despike.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../../index.html"><img alt="<" border="0" src="../../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for gismotools/GISMO/contributed/packages/+matlab_extensions&nbsp;<img alt=">" border="0" src="../../../../../right.png"></a></td></tr></table>-->

<h1>despike
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>======================================================================</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>function [fo, ip] = func_despike_phasespace( fi, i_plot ); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">======================================================================

 Version 2.00

 This subroutine excludes spike noise from Acoustic Doppler 
 Velocimetry (ADV) data using phasce-space method by Goring and 
 Nikora (2002).
 
======================================================================

 Input
   fi     : input data with dimension (n,1)
   i_plot : =9 plot results (optional)

 Output
   fo     : output (filterd) data
   ip     : excluded array element number in xi and yi

 Example: 
   [fo, ip] = func_despike_phasespace_sub( fi, i_plot );


======================================================================
 Terms:

       Distributed under the terms of the terms of the 
       GNU General Public License

 Copyright: Nobuhito Mori, Osaka City University

========================================================================

 Update:
       2.00    2004/12/29 Major bug has been fixed
       1.10    2004/09/06 Iteration is added
       1.00    2004/09/01 Nobuhito Mori, Osaka City University

========================================================================</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [xp, yp, ip] = func_excludeoutlier_ellipsoid( xi, yi, a, b, theta );</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [fo, ip] = func_despike_phasespace( fi, i_plot );</a>
0002 <span class="comment">%======================================================================</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Version 2.00</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% This subroutine excludes spike noise from Acoustic Doppler</span>
0007 <span class="comment">% Velocimetry (ADV) data using phasce-space method by Goring and</span>
0008 <span class="comment">% Nikora (2002).</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%======================================================================</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% Input</span>
0013 <span class="comment">%   fi     : input data with dimension (n,1)</span>
0014 <span class="comment">%   i_plot : =9 plot results (optional)</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Output</span>
0017 <span class="comment">%   fo     : output (filterd) data</span>
0018 <span class="comment">%   ip     : excluded array element number in xi and yi</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Example:</span>
0021 <span class="comment">%   [fo, ip] = func_despike_phasespace_sub( fi, i_plot );</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%======================================================================</span>
0025 <span class="comment">% Terms:</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%       Distributed under the terms of the terms of the</span>
0028 <span class="comment">%       GNU General Public License</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% Copyright: Nobuhito Mori, Osaka City University</span>
0031 <span class="comment">%</span>
0032 <span class="comment">%========================================================================</span>
0033 <span class="comment">%</span>
0034 <span class="comment">% Update:</span>
0035 <span class="comment">%       2.00    2004/12/29 Major bug has been fixed</span>
0036 <span class="comment">%       1.10    2004/09/06 Iteration is added</span>
0037 <span class="comment">%       1.00    2004/09/01 Nobuhito Mori, Osaka City University</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%========================================================================</span>
0040 
0041 <span class="comment">%</span>
0042 <span class="comment">% --- initial setup</span>
0043 <span class="comment">%</span>
0044 
0045 <span class="comment">% number of maximum iternation</span>
0046 n_iter = 10;                    
0047 n_out  = 999;
0048 
0049 n      = size(fi,1);
0050 f_mean = nanmean(fi);
0051 f      = fi - f_mean;
0052 lambda = sqrt(2*log(n));
0053 
0054 <span class="keyword">if</span> nargin==1
0055   i_plot = 0;
0056 <span class="keyword">end</span>
0057 
0058 <span class="comment">%</span>
0059 <span class="comment">% --- loop</span>
0060 <span class="comment">%</span>
0061 
0062 n_loop = 1;
0063 
0064 <span class="keyword">while</span> (n_out~=0) &amp; (n_loop &lt;= n_iter)
0065 
0066 <span class="comment">%</span>
0067 <span class="comment">% --- main</span>
0068 <span class="comment">%</span>
0069 
0070 f = f - nanmean(f);
0071 s = nanstd(f);
0072 
0073 <span class="comment">% step 1: first and second derivatives</span>
0074 f_t  = gradient(f);
0075 f_tt = gradient(f_t);
0076 
0077 <span class="comment">% step 2: calculation of std of f, ft, ftt</span>
0078 s_t  = nanstd(f_t);
0079 s_tt = nanstd(f_tt);
0080 
0081 <span class="comment">% step 3: angle</span>
0082 theta = atan2( sum(f.*f_tt), sum(f.^2) );
0083 
0084 <span class="comment">% step 4: estimation of a and b</span>
0085 f1  =   f*cos(theta) + f_tt*sin(theta);
0086 f2  = - f*sin(theta) + f_tt*cos(theta);
0087 s_1 = std(f1);
0088 s_2 = std(f2);
0089 a_3 = lambda*s_1;
0090 b_3 = lambda*s_2;
0091 
0092 <span class="comment">% step 5: checking outlier in the phase space</span>
0093 <span class="keyword">if</span> isnan(a_3)==0 &amp; isnan(b_3)==0 &amp; isinf(a_3)==0 &amp; isinf(b_3)==0
0094   a_1 = lambda*s;
0095   b_1 = lambda*s_t;
0096   a_2 = lambda*s_t;
0097   b_2 = lambda*s_tt;
0098   <span class="comment">% f-f_ft</span>
0099   [x1_p, y1_p, ip1] = <a href="#_sub1" class="code" title="subfunction [xp, yp, ip] = func_excludeoutlier_ellipsoid( xi, yi, a, b, theta );">func_excludeoutlier_ellipsoid</a>(   f,  f_t, a_1, b_1, 0 );
0100   <span class="comment">% f-f_ft</span>
0101   [x2_p, y2_p, ip2] = <a href="#_sub1" class="code" title="subfunction [xp, yp, ip] = func_excludeoutlier_ellipsoid( xi, yi, a, b, theta );">func_excludeoutlier_ellipsoid</a>( f_t, f_tt, a_2, b_2, 0 );
0102   <span class="comment">% f_t-f_ft</span>
0103   [x3_p, y3_p, ip3] = <a href="#_sub1" class="code" title="subfunction [xp, yp, ip] = func_excludeoutlier_ellipsoid( xi, yi, a, b, theta );">func_excludeoutlier_ellipsoid</a>(   f, f_tt, a_3, b_3, theta );
0104 <span class="keyword">else</span>
0105 
0106     ip1 = [];
0107     ip2 = [];
0108     ip3 = [];
0109 
0110 <span class="keyword">end</span>
0111 
0112 <span class="comment">%</span>
0113 <span class="comment">% --- excluding data</span>
0114 <span class="comment">%</span>
0115 
0116 n_nan_1 = size(find(isnan(f)==1),1);
0117 f(ip1)  = NaN;
0118 f(ip2)  = NaN;
0119 f(ip3)  = NaN;
0120 n_nan_2 = size(find(isnan(f)==1),1);
0121 n_out   = n_nan_2 - n_nan_1;
0122 
0123 <span class="comment">%</span>
0124 <span class="comment">% --- for check</span>
0125 <span class="comment">%</span>
0126 
0127 <span class="keyword">if</span> i_plot == 9 &amp; (isnan(a_3)==0 &amp; isnan(b_3)==0)
0128 
0129 t = 0:pi/64:2*pi;
0130 ip = find(isnan(f));
0131 x1_e = a_1*cos(t);
0132 x2_e = a_2*cos(t);
0133 x3_t = a_3*cos(t);
0134 y1_e = b_1*sin(t);
0135 y2_e = b_2*sin(t);
0136 y3_t = b_3*sin(t);
0137 x3_e = x3_t*cos(theta) - y3_t*sin(theta);
0138 y3_e = x3_t*sin(theta) + y3_t*cos(theta);
0139 
0140 clf;
0141 subplot(2,2,1);
0142 plot(x1_e,y1_e,<span class="string">'b-'</span>);
0143 hold on
0144 plot(f,f_t,<span class="string">'k.'</span>);
0145 plot(x1_p,y1_p,<span class="string">'r.'</span>);
0146 hold off
0147 xlabel(<span class="string">'u'</span>);
0148 ylabel(<span class="string">'\Delta u'</span>);
0149 
0150 subplot(2,2,3);
0151 plot(x3_e,y3_e,<span class="string">'b-'</span>);
0152 hold on
0153 plot(f,f_tt,<span class="string">'k.'</span>);
0154 plot(x3_p,y3_p,<span class="string">'r.'</span>);
0155 hold off
0156 ylabel(<span class="string">'\Delta u'</span>);
0157 ylabel(<span class="string">'\Delta^2 u'</span>);
0158 
0159 subplot(2,2,2);
0160 plot(x2_e,y2_e,<span class="string">'b-'</span>);
0161 hold on
0162 plot(f_t,f_tt,<span class="string">'k.'</span>);
0163 plot(x2_p,y2_p,<span class="string">'r.'</span>);
0164 hold off
0165 xlabel(<span class="string">'\Delta u'</span>);
0166 ylabel(<span class="string">'\Delta^2 u'</span>);
0167 
0168 subplot(2,2,4);
0169 plot(fi,<span class="string">'k-'</span>);
0170 hold on
0171 plot(ip,fi(ip),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,5);
0172 hold off
0173 xlabel(<span class="string">'time'</span>);
0174 ylabel(<span class="string">'u[s]'</span>);
0175 axis tight
0176 <span class="comment">%pause</span>
0177 
0178 <span class="keyword">end</span>
0179 
0180 <span class="comment">%</span>
0181 <span class="comment">% --- end of loop</span>
0182 <span class="comment">%</span>
0183 
0184 n_loop = n_loop + 1;
0185 
0186 <span class="keyword">end</span>
0187 
0188 <span class="comment">%</span>
0189 <span class="comment">% --- post process</span>
0190 <span class="comment">%</span>
0191 
0192 fo = f + f_mean;
0193 ip = find(isnan(fo));
0194 
0195 <span class="keyword">if</span> n_loop &lt; n_iter
0196   debug.print_debug(4,<span class="keyword">...</span>
0197     [<span class="string">'&gt;&gt; Number of outlier   = '</span>, num2str(size(find(isnan(f)==1),1)), <span class="keyword">...</span>
0198      <span class="string">' : Number of iteration = '</span>, num2str(n_loop-1)])
0199 <span class="keyword">else</span>
0200   debug.print_debug(4, <span class="keyword">...</span>
0201     [<span class="string">'&gt;&gt; Number of outlier   = '</span>, num2str(size(find(isnan(f)==1),1)), <span class="keyword">...</span>
0202      <span class="string">' : Number of iteration = '</span>, num2str(n_loop-1), <span class="string">' !!! exceed maximum value !!!'</span>])
0203 <span class="keyword">end</span>
0204 
0205 
0206 
0207 <a name="_sub1" href="#_subfunctions" class="code">function [xp, yp, ip] = func_excludeoutlier_ellipsoid( xi, yi, a, b, theta );</a>
0208 <span class="comment">%======================================================================</span>
0209 <span class="comment">%</span>
0210 <span class="comment">% Version 2.11</span>
0211 <span class="comment">%</span>
0212 <span class="comment">% This program excludes the points outside of ellipsoid in two-</span>
0213 <span class="comment">% dimensional domain</span>
0214 <span class="comment">%</span>
0215 <span class="comment">% Input</span>
0216 <span class="comment">%   xi : input x data</span>
0217 <span class="comment">%   yi : input y data</span>
0218 <span class="comment">%   a  : the major axis</span>
0219 <span class="comment">%   b  : the minor axis</span>
0220 <span class="comment">%</span>
0221 <span class="comment">% Output</span>
0222 <span class="comment">%   xp : excluded x data</span>
0223 <span class="comment">%   yp : excluded y data</span>
0224 <span class="comment">%   ip : excluded array element number in xi and yi</span>
0225 <span class="comment">%</span>
0226 <span class="comment">% Example:</span>
0227 <span class="comment">%   [xp, yp, ip] = func_excludeoutlier_ellipsoid( f, f_t, a, b );</span>
0228 <span class="comment">%</span>
0229 <span class="comment">%</span>
0230 <span class="comment">%======================================================================</span>
0231 <span class="comment">% Terms:</span>
0232 <span class="comment">%</span>
0233 <span class="comment">%       Distributed under the terms of the terms of the</span>
0234 <span class="comment">%       GNU General Public License</span>
0235 <span class="comment">%</span>
0236 <span class="comment">% Copyright: Nobuhito Mori, Osaka City University</span>
0237 <span class="comment">%</span>
0238 <span class="comment">%========================================================================</span>
0239 <span class="comment">%</span>
0240 <span class="comment">% Update:</span>
0241 <span class="comment">%       2.11    2005/01/14 Minor bug has been fixed</span>
0242 <span class="comment">%       2.10    2005/01/12 Minor bug has been fixed</span>
0243 <span class="comment">%       2.00    2004/12/29 Major bug has been fixed</span>
0244 <span class="comment">%       1.01    2004/09/06 Bug fixed</span>
0245 <span class="comment">%       1.00    2004/09/01 Nobuhito Mori, Osaka City University</span>
0246 <span class="comment">%</span>
0247 <span class="comment">%========================================================================</span>
0248 
0249 <span class="comment">%</span>
0250 <span class="comment">% --- initial setup</span>
0251 <span class="comment">%</span>
0252 
0253 n = max(size(xi));
0254 
0255 xp = [];
0256 yp = [];
0257 ip = [];
0258 
0259 <span class="comment">%</span>
0260 <span class="comment">% --- rotate data</span>
0261 <span class="comment">%</span>
0262 
0263 <span class="keyword">if</span> theta == 0
0264   X = xi;
0265   Y = yi;
0266 <span class="keyword">else</span>
0267   X =   xi*cos(theta) + yi*sin(theta);
0268   Y = - xi*sin(theta) + yi*cos(theta);
0269 <span class="keyword">end</span>
0270 
0271 <span class="comment">%</span>
0272 <span class="comment">% --- main</span>
0273 <span class="comment">%</span>
0274 
0275 m = 0;
0276 <span class="keyword">for</span> i=1:n
0277   x1 = X(i);
0278   y1 = Y(i);
0279   <span class="comment">% point on the ellipsoid</span>
0280   <span class="keyword">if</span> x1 ~= 0
0281     x2 = 1 / sqrt( 1/a^2 + 1/b^2*(y1^2/x1^2) );
0282   <span class="keyword">else</span>
0283     x2 = a;
0284   <span class="keyword">end</span>
0285   y2 = sqrt( (1 - x2^2/a^2)*b^2 );
0286   <span class="keyword">if</span> x1 &lt; 0
0287     x2 = -x2;
0288   <span class="keyword">end</span>
0289   <span class="keyword">if</span> y1 &lt; 0
0290     y2 = -y2;
0291   <span class="keyword">end</span>
0292   dis = (x2^2+y2^2) - (x1^2+y1^2);
0293   <span class="keyword">if</span> dis &lt; 0 
0294     m = m + 1;
0295     ip(m) = i;
0296 <span class="comment">%    xt(m) = x1;</span>
0297 <span class="comment">%    yt(m) = y1;</span>
0298     xp(m) = xi(i);
0299     yp(m) = yi(i);
0300   <span class="keyword">end</span>
0301 <span class="keyword">end</span>
0302 
0303 <span class="comment">%</span>
0304 <span class="comment">% --- rotate data / reverse</span>
0305 <span class="comment">%</span>
0306 
0307 <span class="comment">%if theta == 0</span>
0308 <span class="comment">%  xp = xt;</span>
0309 <span class="comment">%  yp = yt;</span>
0310 <span class="comment">%else</span>
0311 <span class="comment">%  xp = xt*cos(theta) - yt*sin(theta);</span>
0312 <span class="comment">%  yp = xt*sin(theta) + yt*cos(theta);</span>
0313 <span class="comment">%end</span></pre></div>
<hr><address>Generated on Sun 11-Oct-2015 14:40:09 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>